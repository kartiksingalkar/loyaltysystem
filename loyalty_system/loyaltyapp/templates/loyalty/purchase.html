{% extends 'loyalty/base.html' %}

{% block title %}Purchase from {{ shop.name }}{% endblock %}

{% block content %}
    <h2>{{ shop.name }}</h2>
    <form method="post" id="purchaseForm">
        {% csrf_token %}
        <label for="item">Select Item:</label>
        <select name="item_id" id="item" onchange="updateTotal()">
            {% for item in items %}
                <option value="{{ item.id }}" data-price="{{ item.price }}" data-points="{{ item.loyalty_points }}">
                    {{ item.name }} - {{ item.price }} - {{ item.loyalty_points }} points
                </option>
            {% endfor %}
        </select>
        <br>
        <label for="quantity">Quantity:</label>
        <input type="number" name="quantity" id="quantity" value="1" min="1" onchange="updateTotal()">
        <br>
        <label for="redeem_points">Redeem Points (Available: {{ customer.active_points }}):</label>
        <input type="number" name="redeem_points" id="redeem_points" value="0" max="{{ customer.active_points }}">
        <br>
        <label for="expiration_date">Expiration Date:</label>
        <input type="date" name="expiration_date" id="expiration_date">
        <br>
        <!-- <label for="merchant_id">Merchant ID:</label>
        <input type="number" name="merchant_id" id="merchant_id"> -->
        <br>
        <button type="submit">Purchase</button>
    </form>

    <p>Total Price: <span id="total_price">0</span></p>
    <p>Total Points Earned: <span id="total_points_earned">0</span></p>

    <h3>Available Loyalty Points for Redemption</h3>
    <ul>
        {% for point in loyalty_points %}
            <li>
                {{ point.points }} points from {{ point.shop.name }} ({{ point.date_earned }}) - Status: {{ point.status }}
            </li>
        {% endfor %}
    </ul>
{% endblock %}

<script>
function updateTotal() {
    const itemSelect = document.getElementById('item');
    const quantityInput = document.getElementById('quantity');
    const totalPriceElement = document.getElementById('total_price');
    const totalPointsElement = document.getElementById('total_points_earned');

    const selectedItem = itemSelect.options[itemSelect.selectedIndex];
    const itemPrice = parseFloat(selectedItem.getAttribute('data-price'));
    const itemPoints = parseInt(selectedItem.getAttribute('data-points'));
    const quantity = parseInt(quantityInput.value);

    const totalPrice = itemPrice * quantity;
    const totalPoints = itemPoints * quantity;

    totalPriceElement.textContent = totalPrice.toFixed(2);
    totalPointsElement.textContent = totalPoints;
}

// Initial calculation
updateTotal();
</script>
